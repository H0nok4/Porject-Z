using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using ConfigType;
using UnityEngine;
using UnityEngine.UIElements;

public abstract class Thing_Unit : ThingWithComponent , IThingHolder {
    private const int MaxTickPerMove = 600;

    public ThingUnit_JobTracker JobTracker;

    public ThingUnit_JobThinker JobThinker;

    public ThingUnit_WorkSetting WorkSetting;

    public PathMover PathMover;
    public int TickPerMoveDiagonal => TicksPerMove(true);
    public int TickPerMoveCardinal => TicksPerMove(false);
    /// <summary>
    /// 最基础的移动一格需要多少Tick
    /// </summary>
    /// <param name="cardinal"></param>
    /// <returns></returns>
    public int TicksPerMove(bool cardinal)
    {
        //比如5格的移速，等于在60Tick中可以走5格，等于12Tick每格
        var moveSpeed = MoveSpeed; 

        float perSecondMoveCount = GameTicker.TicksPerSecond / moveSpeed;

        if (perSecondMoveCount < 1)
        {
            //最少都得1Tick走1格
            perSecondMoveCount = 1;
        }

        if (cardinal)
        {
            //对角线需要*1.414
            perSecondMoveCount *= 1.414f;
        }

        return Math.Clamp(Mathf.FloorToInt(perSecondMoveCount), 1, MaxTickPerMove);
    }

    public override void Tick()
    {
        PathMover.Tick();

        if (JobTracker != null) {
            JobTracker.JobTrackTick();
        }
    }

    public override void SpawnSetup(MapData mapData)
    {
        base.SpawnSetup(mapData);
        JobTracker = new ThingUnit_JobTracker(this);
        PathMover = new PathMover(this);
        JobThinker = new ThingUnit_JobThinker();
        JobThinker.ThinkTreeDefine = PawnThinkTree.Instance;
        ThingType = ThingCategory.Unit;
        WorkSetting = new ThingUnit_WorkSetting(this);

        GameTicker.Instance.RegisterThing(this);
    }


    public override void DeSpawn()
    {
        base.DeSpawn();
        GameTicker.Instance.UnRegisterThing(this);
    }

    public IThingHolder Parent
    {
        get
        {
            return base.ParentHolder;
        }
    }


    public void GetChildren(List<IThingHolder> outChildren)
    {
        //TODO:例如角色可能会有背包，身上的装备烂，手上携带的东西

    }

    public ThingOwner GetHoldingThing()
    {
        return null;
    }


    public bool IsInside(Thing thing)
    {
        //TODO:目前只有单格大小的物体，后续加入体积设定后需要重新做
        if (Position.MapDataIndex != thing.Position.MapDataIndex)
        {
            return false;
        }

        return this.Position.Pos.X == thing.Position.Pos.X && this.Position.Pos.Y == thing.Position.Pos.Y;
    }
}